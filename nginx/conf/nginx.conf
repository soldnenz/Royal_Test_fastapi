worker_processes auto;  # Auto-detect CPU cores instead of 1

# Increase file limits for better performance
worker_rlimit_nofile 4096;

events {
    worker_connections 2048;  # Increased from 1024 for more concurrent tests
    multi_accept on;
    use select;  # Efficient connection handling on Linux use epoll;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Security: Basic settings
    server_tokens off;  # Don't show Nginx version
    client_body_buffer_size 16K;
    client_header_buffer_size 1k;
    client_max_body_size 155M;  # Matching API setting
    large_client_header_buffers 4 8k;  # Increased for complex requests
    client_body_timeout 20;  # Increased for large file uploads
    client_header_timeout 10;
    send_timeout 15;

    # Performance settings optimized for testing
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 45;  # Increased for test sessions
    keepalive_requests 200;  # More requests per connection for full test
    reset_timedout_connection on;
    
    # Backend connection settings optimized for testing
    proxy_connect_timeout 10s;  # Increased for stability
    proxy_send_timeout 15s;
    proxy_read_timeout 120s;  # Increased for large media files
    proxy_buffers 32 32k;  # More buffers for concurrent requests
    proxy_buffer_size 64k;
    proxy_busy_buffers_size 256k;
    proxy_temp_file_write_size 256k;
    proxy_http_version 1.1;   
    proxy_set_header Connection ""; 

    # Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml application/json;
    gzip_disable "MSIE [1-6]\.";

    # Logging
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  logs/access.log  main;
    error_log   logs/error.log info;

    # Security: Rate limiting zones - optimized for testing with Cloudflare protection
    limit_req_zone $binary_remote_addr zone=main:20m rate=80r/s;      # Increased for normal browsing
    limit_req_zone $binary_remote_addr zone=api:20m rate=50r/s;       # Increased for test API calls
    limit_req_zone $binary_remote_addr zone=admin:10m rate=25r/s;     # Increased for admin work
    limit_req_zone $binary_remote_addr zone=media:30m rate=30r/s;     # New zone for media files
    limit_req_zone $binary_remote_addr zone=ws:10m rate=10r/s;        # New zone for WebSocket connections

    # Connection limiting for resource protection
    limit_conn_zone $binary_remote_addr zone=perip:10m;
    limit_conn_zone $server_name zone=perserver:10m;

    # Blocking Map for security restrictions
    map $uri $blocked_file {
        default 0;
        ~*\.(git|svn|htaccess|bash_history|env|log|conf|md)$ 1;
    }

    # Map to block vulnerability scanners
    map $uri $blocked_path {
        default 0;
        ~*/(phpunit|eval-stdin|think|invokefunction|pearcmd|vendor)/? 1;
    }

    # Map to block common attack patterns
    map $uri $blocked_ext {
        default 0;
        ~*\.(php|asp|aspx|jsp|cgi|pl)$ 1;
    }

    # Map to fix admin assets - check if request comes from admin page
    map $http_referer $asset_path {
        "~*/admin/" "C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend_admin/dist/assets/";
        default "C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend/dist/assets/";
    }

    server {
        listen       443 ssl;
        http2        on;  # Enable HTTP/2
        server_name  localhost;

        # Block requests based on maps
        if ($blocked_file) {
            return 404;
        }
        
        if ($blocked_path) {
            return 404;
        }
        
        if ($blocked_ext) {
            return 404;
        }

        # Create a custom 404 page to avoid errors in logs
        location /404.html {
            return 404 "404 Not Found";
        }

        # Enhanced SSL configuration
        ssl_certificate      ../../ssl/certificate.crt;
        ssl_certificate_key  ../../ssl/private.key;
        ssl_trusted_certificate ../../ssl/ca_bundle.crt;

        # Security: SSL settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;
        
        # HSTS (15768000 seconds = 6 months)
        add_header Strict-Transport-Security "max-age=15768000; includeSubDomains" always;

        # Security headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'self' https://challenges.cloudflare.com https://*.cloudflare.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://challenges.cloudflare.com https://*.cloudflare.com blob: data: 'sha256-*'; img-src 'self' data: blob: https://unpkg.com https://*.cloudflare.com; media-src 'self' data: blob: https://*.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com https://*.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://unpkg.com https://*.cloudflare.com; connect-src 'self' https://challenges.cloudflare.com https://*.cloudflare.com wss: ws:; frame-src 'self' https://challenges.cloudflare.com https://*.cloudflare.com data: blob:; child-src 'self' https://challenges.cloudflare.com https://*.cloudflare.com blob: data:; worker-src 'self' https://challenges.cloudflare.com https://*.cloudflare.com blob: data:; object-src 'self' https://challenges.cloudflare.com https://*.cloudflare.com blob: data:; frame-ancestors 'self' https://challenges.cloudflare.com https://*.cloudflare.com; form-action 'self' https://challenges.cloudflare.com https://*.cloudflare.com;" always;

        # 1) WebSocket через API путь - должно быть ПЕРЕД обычным API
        location ^~ /api/ws/ {
            proxy_pass         http://127.0.0.1:8000/ws/;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade             $http_upgrade;
            proxy_set_header   Connection          "Upgrade";
            proxy_set_header   Host                $host;
            proxy_set_header   X-Real-IP           $remote_addr;
            proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto   $scheme;
            proxy_set_header   X-Forwarded-Host    $host;
            proxy_set_header   X-Forwarded-Port    $server_port;
            
            proxy_connect_timeout 10s;
            proxy_read_timeout 3600s;    # 1 hour for long test sessions
            proxy_send_timeout 30s;
            
            # WebSocket special settings
            proxy_buffering off;
            
            # Rate limiting for WebSocket connections
            limit_req zone=ws burst=5 nodelay;
            
            # Connection limits for WebSocket
            limit_conn perip 10;  # Max 10 WS connections per IP
        }

        # 2) API: ВСЕ пути, начинающиеся с /api
        #    — сразу в бэкенд, без перехвата ошибок
        location ^~ /api/ {
            proxy_pass         http://127.0.0.1:8000/;
            proxy_set_header   Host                $host;
            proxy_set_header   X-Real-IP           $remote_addr;
            proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto   $scheme;
            proxy_set_header   X-Forwarded-Host    $host;
            proxy_set_header   X-Forwarded-Port    $server_port;
            proxy_set_header   Connection          ""; # Keep-alive
            
            client_max_body_size 155M;
            proxy_connect_timeout 10s;   # Increased for stability
            proxy_read_timeout 120s;     # Increased for large responses
            
            # Connection reuse optimization
            proxy_http_version 1.1;
            keepalive_requests 200;
            
            # Response buffering
            proxy_buffering on;
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            
            # Handle large requests better
            proxy_request_buffering off;
            
            # Security: Rate limiting for API - optimized for testing
            limit_req zone=api burst=100 nodelay;  # Increased burst for test sequences
            
            # Connection limits per IP
            limit_conn perip 20;  # Max 20 concurrent connections per IP
        }

        # 3) WebSocket: прямой путь (оставляем для совместимости)
        location ^~ /ws/ {
            proxy_pass         http://127.0.0.1:8000;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade             $http_upgrade;
            proxy_set_header   Connection          "Upgrade";
            proxy_set_header   Host                $host;
            proxy_set_header   X-Real-IP           $remote_addr;
            proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto   $scheme;
            proxy_set_header   X-Forwarded-Host    $host;
            proxy_set_header   X-Forwarded-Port    $server_port;
            
            proxy_connect_timeout 10s;   # Increased for stability
            proxy_read_timeout 3600s;    # 1 hour for long test sessions
            proxy_send_timeout 30s;      # Quick send timeout
            
            # WebSocket special settings
            proxy_buffering off;
            
            # Rate limiting for WebSocket connections
            limit_req zone=ws burst=5 nodelay;
            
            # Connection limits for WebSocket
            limit_conn perip 10;  # Max 10 WS connections per IP
        }

        # 4) Media files: X-Accel-Redirect для прямой отдачи файлов
        location ^~ /media/ {
            # Внутренний location для X-Accel-Redirect
            internal;
            
            # Путь к файлам медиа
            alias C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/video_test/;
            
            # Безопасность: проверяем, что файл существует и не выходит за пределы директории
            if (!-f $request_filename) {
                return 404;
            }
            
            # Дополнительная проверка безопасности: блокируем попытки выхода за пределы директории
            if ($request_filename !~ "^C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/video_test/") {
                return 404;
            }
            
            # Блокируем доступ к системным файлам и скрытым директориям
            location ~ /\. {
                deny all;
                return 404;
            }
            
            # Блокируем опасные типы файлов
            location ~* \.(php|asp|aspx|jsp|cgi|pl|sh|exe|bat|cmd|com|pif|scr|vbs|js|py|rb|perl)$ {
                deny all;
                return 404;
            }
            
            # Блокируем конфигурационные файлы
            location ~* \.(htaccess|htpasswd|ini|log|conf|config|bak|backup|tmp|temp)$ {
                deny all;
                return 404;
            }
            
            # Оптимизация для стриминга больших файлов
            sendfile on;
            tcp_nopush on;
            tcp_nodelay on;

            # Дополнительные оптимизации для стриминга (Windows-совместимые)
            # aio и directio не поддерживаются на Windows

            # Кэширование для медиафайлов (1 год для статических медиа)
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";

            # Безопасность: заголовки для медиафайлов
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header X-Download-Options "noopen" always;
            add_header X-Permitted-Cross-Domain-Policies "none" always;

            # Поддержка Range requests для стриминга
            add_header Accept-Ranges "bytes" always;

            # Оптимизация для стриминга видео
            location ~* \.(mp4|mov)$ {
                mp4;
                mp4_buffer_size     1m;
                mp4_max_buffer_size 5m;

                # Защита от хотлинкинга
                valid_referers royal-test.duckdns.org localhost;
                if ($invalid_referer) {
                    return 403;
                }
            }

            # Ограничения на размер файла (50MB) - применяется к загрузкам, не к отдаче
            # client_max_body_size 50M;

            # Rate limiting для медиафайлов
            limit_req zone=media burst=20 nodelay;
            limit_conn perip 15;  # Max 15 concurrent media downloads per IP

            # Логирование доступа к медиафайлам
            access_log logs/media_access.log main;
        }
        
        # 4.1) API для медиафайлов (проксирование к бэкенду)
        location ^~ /api/files/ {
            proxy_pass         http://127.0.0.1:8000/;
            proxy_set_header   Host                $host;
            proxy_set_header   X-Real-IP           $remote_addr;
            proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto   $scheme;
            
            # Optimized for large media files
            proxy_connect_timeout 10s;
            proxy_read_timeout 300s;    # 5 minutes for large files
            proxy_send_timeout 60s;
            
            # Buffering settings for media
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 16 128k;
            proxy_busy_buffers_size 256k;
            
            # Rate limiting for media files
            limit_req zone=media burst=20 nodelay;
            
            # Connection limits for media
            limit_conn perip 15;  # Max 15 concurrent media downloads per IP
        }

        # 5) Admin-папка: increased limits for admin work
        location ^~ /admin {
            # 1) Проверяем доступ
            auth_request /auth_admin;
            
            # 2) При ошибке авторизации (включая 401 от auth_error), редиректим на главную
            error_page 401 403 = @redirect_main;
            
            # 3) Отдаём статику из dist папки React приложения
            alias C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend_admin/dist/;
            index index.html;
            try_files $uri $uri/ /admin/index.html;
            
            # Security: Rate limiting for admin pages - increased for active work
            limit_req zone=admin burst=50 nodelay;  # Increased burst for admin operations
            
            # Connection limits for admin
            limit_conn perip 10;  # Max 10 concurrent admin connections per IP
            
            # 4) Перехватываем ошибки и кидаем в React (@dist)
            proxy_intercept_errors on;
            error_page 404 = @dist;
        }

        # Handle admin assets specifically
        location ^~ /admin/assets/ {
            alias     C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend_admin/dist/assets/;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000";
            
            # Add back security headers for static content
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
        }

        # Handle regular frontend assets, with special case for admin referrers
        location ^~ /assets/ {
            alias     $asset_path;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000";
            
            # Add back security headers for static content
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
        }

        # internal-location для проверки доступа
        location = /auth_admin {
            internal;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            
            # Установка пользовательского заголовка для отлова 404 ошибки
            proxy_intercept_errors on;
            proxy_set_header X-Original-URI $request_uri;
            
            # Важно: Мы по-прежнему хотим, чтобы 404 был возвращен как 401 для auth_request
            error_page 404 = /auth_error;
            
            # Проксируем к бэкенду
            proxy_pass http://127.0.0.1:8000/auth/validate-admin;
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Quick timeouts for auth checks
            proxy_connect_timeout 5s;
            proxy_read_timeout 10s;
        }
        
        # Специальный location для возврата 401 вместо 404
        location = /auth_error {
            internal;
            return 401;
        }

        # 6) Catch-all: main frontend with connection limits
        location / {
            root     C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend/dist;
            index     index.html;
            try_files $uri $uri/ /index.html;
            
            # Security: Rate limiting for main site - increased for normal usage
            limit_req zone=main burst=150 nodelay;  # Increased burst for SPA navigation
            
            # Connection limits for main site
            limit_conn perip 30;  # Max 30 concurrent connections per IP for main site
            limit_conn perserver 2000;  # Max 2000 concurrent connections to server
        }

        # 7) @vite — внутренний редирект в SPA
        location @vite {
            internal;
            # Redirect to the index.html of the frontend
            return 302 /index.html;
        }

        # Новый location @dist для обработки React SPA
        location @dist {
            internal;
            # Redirect to the admin index.html
            return 302 /admin/index.html;
        }
        
        # Редирект на главную страницу при отказе в доступе
        location @redirect_main {
            internal;
            return 302 /;
        }

        # Public static files directory with enhanced security
        location /static/ {
            alias C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/static/;
            
            # Enhanced security: Only allow requests from our domain
            if ($http_referer !~ "^https?://(royal-test\.duckdns\.org|localhost)") {
                return 403;
            }
            
            # Allow public access to static files
            allow all;
            
            # Security headers for static content
            add_header X-Frame-Options "SAMEORIGIN";
            add_header X-Content-Type-Options "nosniff";
            add_header X-XSS-Protection "1; mode=block";
            add_header Cache-Control "public, max-age=31536000";
            add_header Referrer-Policy "strict-origin-when-cross-origin";
            
            # Prevent directory listing
            autoindex off;
            
            # Only allow GET and HEAD methods
            limit_except GET HEAD {
                deny all;
            }
            
            # Set proper MIME types and restrict file types
            types {
                video/mp4 mp4;
                image/jpeg jpg jpeg;
                image/png png;
                image/gif gif;
                image/x-icon ico;
                text/css css;
                application/javascript js;
            }
            
            # Block dangerous file types
            location ~* \.(php|asp|aspx|jsp|cgi|pl|sh|exe|bat|cmd|com|pif|scr|vbs|js)$ {
                deny all;
                return 404;
            }
            
            # Prevent access to hidden files and system files
            location ~ /\. {
                deny all;
                return 404;
            }
            
            # Block access to configuration files
            location ~* \.(htaccess|htpasswd|ini|log|sh|sql|fla|psd|psp|xml|json|lock|bak|tmp|temp)$ {
                deny all;
                return 404;
            }
            
            # Rate limiting for static files - stricter limits
            limit_req zone=media burst=10 nodelay;
            limit_conn perip 5;  # Max 5 concurrent static file downloads per IP
            
            # Set maximum file size limit (10MB)
            client_max_body_size 10M;
            
            # Prevent hotlinking
            valid_referers royal-test.duckdns.org localhost;
            if ($invalid_referer) {
                return 403;
            }
        }
    }

    # HTTP сервер для ACME challenge и редирект на HTTPS
    server {
        listen 80;
        server_name localhost royal-test.duckdns.org;
        
        # ACME challenge для Let's Encrypt
        location ^~ /.well-known/acme-challenge/ {
            root C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/;
            default_type "text/plain";
            try_files $uri =404;
            
            # Разрешаем только GET и HEAD методы
            limit_except GET HEAD {
                deny all;
            }
            
            # Не требуем SSL для ACME challenge
            add_header Cache-Control "no-cache";
            
            # Лог для отладки ACME challenge
            access_log logs/acme_challenge.log main;
        }
        
        # Все остальные запросы перенаправляем на HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }
}
