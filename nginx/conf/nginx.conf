worker_processes 1;

# Security: Restrict worker connections and file access
worker_rlimit_nofile 1024;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Security: Basic settings
    server_tokens off;  # Don't show Nginx version
    client_body_buffer_size 10K;
    client_header_buffer_size 1k;
    client_max_body_size 155M;  # Matching API setting
    large_client_header_buffers 2 1k;
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;

    # Performance settings
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 30;  # Уменьшаем с 65 до 30
    keepalive_requests 100;  # Добавляем явное количество запросов на одно соединение
    reset_timedout_connection on;
    
    # Соединения бэкенда
    proxy_connect_timeout 5s;  # Уменьшаем с 75s до 5s
    proxy_send_timeout 10s;
    proxy_read_timeout 60s;    # Уменьшаем с 300s до 60s, но оставляем достаточно для больших ответов
    proxy_buffers 16 32k;
    proxy_buffer_size 64k;
    proxy_busy_buffers_size 128k;
    proxy_temp_file_write_size 128k;
    proxy_http_version 1.1;    # Используем HTTP/1.1 для всех прокси-запросов
    proxy_set_header Connection "";  # Убираем заголовок Connection для keepalive

    # Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml application/json;
    gzip_disable "MSIE [1-6]\.";

    # Logging
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  logs/access.log  main;
    error_log   logs/error.log info;

    # Security: Rate limiting zones
    limit_req_zone $binary_remote_addr zone=main:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=15r/s;
    limit_req_zone $binary_remote_addr zone=admin:10m rate=10r/s;

    # Blocking Map for security restrictions
    map $uri $blocked_file {
        default 0;
        ~*\.(git|svn|htaccess|bash_history|env|log|conf|md)$ 1;
    }

    # Map to block vulnerability scanners
    map $uri $blocked_path {
        default 0;
        ~*/(phpunit|eval-stdin|think|invokefunction|pearcmd|vendor)/? 1;
    }

    # Map to block common attack patterns
    map $uri $blocked_ext {
        default 0;
        ~*\.(php|asp|aspx|jsp|cgi|pl)$ 1;
    }

    # Map to fix admin assets - check if request comes from admin page
    map $http_referer $asset_path {
        "~*/admin/" "C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend_admin/dist/assets/";
        default "C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend/dist/assets/";
    }

    server {
        listen       443 ssl;
        http2        on;  # Enable HTTP/2
        server_name  localhost;

        # Block requests based on maps
        if ($blocked_file) {
            return 404;
        }
        
        if ($blocked_path) {
            return 404;
        }
        
        if ($blocked_ext) {
            return 404;
        }

        # Create a custom 404 page to avoid errors in logs
        location /404.html {
            return 404 "404 Not Found";
        }

        # Enhanced SSL configuration
        ssl_certificate      ../../ssl/fullchain.pem;
        ssl_certificate_key  ../../ssl/private.key;

        # Security: SSL settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;
        
        # HSTS (15768000 seconds = 6 months)
        add_header Strict-Transport-Security "max-age=15768000; includeSubDomains" always;

        # Security headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: blob: https://unpkg.com; media-src 'self' data: blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com https://unpkg.com; connect-src 'self'; frame-ancestors 'self'; form-action 'self';" always;

        # 1) API: ВСЕ пути, начинающиеся с /api
        #    — сразу в бэкенд, без перехвата ошибок
        location ^~ /api/ {
            proxy_pass         http://127.0.0.1:8000/;
            proxy_set_header   Host                $host;
            proxy_set_header   X-Real-IP           $remote_addr;
            proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto   $scheme;
            proxy_set_header   X-Forwarded-Host    $host;
            proxy_set_header   X-Forwarded-Port    $server_port;
            proxy_set_header   Connection          ""; # Keep-alive
            
            client_max_body_size 155M;
            proxy_connect_timeout 5s;    # Уменьшаем timeout
            proxy_read_timeout 60s;      # Уменьшаем, но оставляем достаточно для больших ответов
            
            # Кэширование соединений
            proxy_http_version 1.1;
            keepalive_requests 100;
            
            # Буферизация ответов
            proxy_buffering on;
            proxy_buffer_size 64k;
            proxy_buffers 16 32k;
            
            # Сбрасываем таймер на больших запросах
            proxy_request_buffering off;
            
            # Security: Rate limiting for API
            limit_req zone=api burst=20 nodelay;
            
            # нет proxy_intercept_errors и error_page — бэкенд сам отдаёт свой 404
        }

        # 2) WebSocket: аналогично
        location ^~ /ws/ {
            proxy_pass         http://127.0.0.1:8000;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade             $http_upgrade;
            proxy_set_header   Connection          "Upgrade";
            proxy_set_header   Host                $host;
            proxy_set_header   X-Real-IP           $remote_addr;
            proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto   $scheme;
            proxy_set_header   X-Forwarded-Host    $host;
            proxy_set_header   X-Forwarded-Port    $server_port;
            
            proxy_connect_timeout 5s;    # Уменьшаем с 75s до 5s
            proxy_read_timeout 60s;      # Уменьшаем с 300s до 60s
            
            # WebSocket special settings
            proxy_buffering off;
        }

        # 3) Админ-папка:
        #    — Отдаём статику из frontend_admin/dist
        #    — SPA-роуты обрабатываются через index.html
        location ^~ /admin {
            # 1) Проверяем доступ
            auth_request /auth_admin;
            
            # 2) При ошибке авторизации (включая 401 от auth_error), редиректим на главную
            error_page 401 403 = @redirect_main;
            
            # 3) Отдаём статику из dist папки React приложения
            alias C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend_admin/dist/;
            index index.html;
            try_files $uri $uri/ /admin/index.html;
            
            # Security: Rate limiting for admin pages
            limit_req zone=admin burst=10 nodelay;
            
            # 4) Перехватываем ошибки и кидаем в React (@dist)
            proxy_intercept_errors on;
            error_page 404 = @dist;
        }

        # Handle admin assets specifically
        location ^~ /admin/assets/ {
            alias     C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend_admin/dist/assets/;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000";
            
            # Add back security headers for static content
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
        }

        # Handle regular frontend assets, with special case for admin referrers
        location ^~ /assets/ {
            alias     $asset_path;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000";
            
            # Add back security headers for static content
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
        }

        # internal-location для проверки доступа
        location = /auth_admin {
            internal;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            
            # Установка пользовательского заголовка для отлова 404 ошибки
            proxy_intercept_errors on;
            proxy_set_header X-Original-URI $request_uri;
            
            # Важно: Мы по-прежнему хотим, чтобы 404 был возвращен как 401 для auth_request
            error_page 404 = /auth_error;
            
            # Проксируем к бэкенду
            proxy_pass http://127.0.0.1:8000/auth/validate-admin;
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Специальный location для возврата 401 вместо 404
        location = /auth_error {
            internal;
            return 401;
        }

        # 4) Catch-all: всё остальное идёт в frontend/dist,
        #    а если файл не найден, отдаём index.html для SPA-маршрутов
        location / {
            root     C:/Users/PolnoKrasoti/PycharmProjects/Royal_Test/frontend/dist;
            index     index.html;
            try_files $uri $uri/ /index.html;
            
            # Security: Rate limiting for main site
            limit_req zone=main burst=30 nodelay;
        }

        # 5) @vite — внутренний редирект в SPA
        location @vite {
            internal;
            # Redirect to the index.html of the frontend
            return 302 /index.html;
        }

        # Новый location @dist для обработки React SPA
        location @dist {
            internal;
            # Redirect to the admin index.html
            return 302 /admin/index.html;
        }
        
        # Редирект на главную страницу при отказе в доступе
        location @redirect_main {
            internal;
            return 302 /;
        }
    }

    # HTTP -> HTTPS редирект
    server {
        listen 80;
        server_name localhost;
        return 301 https://$host$request_uri;
    }
}
