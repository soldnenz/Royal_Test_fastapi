<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админ: Управление реферальными кодами</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    h1, h2 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .btn { margin: 2px; padding: 5px 10px; cursor: pointer; }
    .error { color: red; }
    .result { margin-top: 20px; }
    .form-section { margin-top: 30px; border: 1px solid #ddd; padding: 15px; }
    .form-section input, .form-section select, .form-section textarea {
      width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Админ: Управление реферальными кодами</h1>

    <!-- Поиск пользователей -->
    <div>
      <h2>Поиск пользователей</h2>
      <input type="text" id="searchQuery" placeholder="Введите ID, ИИН, email, телефон или ФИО">
      <button id="searchBtn" class="btn">Найти пользователей</button>
    </div>

    <div id="usersResult" class="result"></div>

    <!-- Форма создания реферального кода -->
    <div id="createForm" class="form-section" style="display:none;">
      <h2>Создать реферальный код для пользователя</h2>
      <input type="hidden" id="formUserId">
      <label for="formCode">Код (необязательно):</label>
      <input type="text" id="formCode" placeholder="Введите код (латиница, кириллица, цифры, _ - + =)">
      <label for="formType">Тип:</label>
      <select id="formType">
        <option value="user">user</option>
        <option value="school">school</option>
      </select>
      <label for="formRate">Процент (0-100):</label>
      <input type="number" id="formRate" placeholder="Например, 10" min="0" max="100">
      <label for="formDescription">Описание:</label>
      <textarea id="formDescription" placeholder="Описание реферального кода (до 256 символов)"></textarea>
      <label for="formComment">Комментарий (опционально):</label>
      <input type="text" id="formComment" placeholder="Введите комментарий">
      <button id="createReferralBtn" class="btn">Создать код</button>
      <button id="cancelFormBtn" class="btn">Отмена</button>
    </div>

    <!-- Результат операций -->
    <div id="operationResult" class="result"></div>
  </div>

  <script>
    // Функция для получения токена из cookie
    function getAccessToken() {
      const token = document.cookie
        .split('; ')
        .find(row => row.startsWith('access_token='))?.split('=')[1];
      return token ? `Bearer ${token}` : '';
    }

    // Функция для отображения сообщений
    function displayMessage(elementId, message, isError = false) {
      document.getElementById(elementId).innerHTML = `<p class="${isError ? 'error' : ''}">${message}</p>`;
    }

    // Функция для поиска пользователей через /api/users/admin/search_users
    async function searchUsers() {
      const query = document.getElementById('searchQuery').value.trim();
      if (!query) {
        displayMessage('usersResult', 'Введите поисковый запрос', true);
        return;
      }
      const token = getAccessToken();
      try {
        const response = await fetch(`/api/users/admin/search_users?query=${encodeURIComponent(query)}`, {
          headers: { 'Authorization': token }
        });
        const data = await response.json();
        if (!response.ok) {
          displayMessage('usersResult', `Ошибка: ${data.detail ? JSON.stringify(data.detail) : data.message}`, true);
          return;
        }
        let users = data.data;
        if (!users || users.length === 0) {
          displayMessage('usersResult', 'Пользователи не найдены', true);
          return;
        }
        let html = `<table>
                      <tr>
                        <th>ID</th>
                        <th>ФИО</th>
                        <th>Email</th>
                        <th>Действия</th>
                      </tr>`;
        users.forEach(user => {
          html += `<tr>
                     <td>${user.id || user._id}</td>
                     <td>${user.full_name || ""}</td>
                     <td>${user.email || ""}</td>
                     <td>
                       <button class="btn" onclick="showCreateForm('${user.id || user._id}')">Создать код</button>
                       <button class="btn" onclick="viewReferral('${user.id || user._id}')">Посмотреть код</button>
                       <button class="btn" onclick="cancelReferral('${user.id || user._id}')">Отменить код</button>
                     </td>
                   </tr>`;
        });
        html += `</table>`;
        document.getElementById('usersResult').innerHTML = html;
      } catch (error) {
        displayMessage('usersResult', `Ошибка: ${error.message}`, true);
      }
    }

    // Функция для открытия формы создания кода для выбранного пользователя
    function showCreateForm(userId) {
      document.getElementById('formUserId').value = userId;
      // Очистить предыдущие значения
      document.getElementById('formCode').value = "";
      document.getElementById('formRate').value = "";
      document.getElementById('formDescription').value = "";
      document.getElementById('formComment').value = "";
      // По умолчанию, для создания обычного кода, тип = "user"
      document.getElementById('formType').value = "user";
      document.getElementById('createForm').style.display = "block";
    }

    document.getElementById('cancelFormBtn').addEventListener('click', () => {
      document.getElementById('createForm').style.display = "none";
    });

    // Функция для создания реферального кода администратором (POST /api/referrals/admin)
    async function createReferral(userIdFromForm) {
      const token = getAccessToken();
      // Собираем данные из формы
      const code = document.getElementById('formCode').value.trim();
      const type = document.getElementById('formType').value;
      const rateValue = document.getElementById('formRate').value;
      const description = document.getElementById('formDescription').value.trim();
      const comment = document.getElementById('formComment').value.trim();
      const owner_user_id = userIdFromForm;
      // Формируем объект запроса. Если поле rate не заполнено, backend установит ставку по умолчанию.
      const payload = {
        code: code || null,
        type: type,
        owner_user_id: owner_user_id,
        rate: rateValue ? { type: "percent", value: Number(rateValue) } : null,
        description: description,
        comment: comment || null
      };
      try {
        const response = await fetch('/api/referrals/admin', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": token
          },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (!response.ok) {
          displayMessage('operationResult', `Ошибка при создании: ${data.detail ? JSON.stringify(data.detail) : data.message}`, true);
          return;
        }
        displayMessage('operationResult', `Реферальный код создан: ${JSON.stringify(data.data)}`);
        document.getElementById('createForm').style.display = "none";
      } catch (error) {
        displayMessage('operationResult', `Ошибка: ${error.message}`, true);
      }
    }

    document.getElementById('createReferralBtn').addEventListener('click', () => {
      const userId = document.getElementById('formUserId').value;
      createReferral(userId);
    });

    // Функция для просмотра реферального кода (GET /api/referrals?owner_user_id=...&active=true)
    async function viewReferral(userId) {
      const token = getAccessToken();
      try {
        const response = await fetch(`/api/referrals/?owner_user_id=${encodeURIComponent(userId)}&active=true`, {
          headers: { "Authorization": token }
        });
        const data = await response.json();
        if (!response.ok) {
          displayMessage('operationResult', `Ошибка при получении кода: ${data.detail ? JSON.stringify(data.detail) : data.message}`, true);
          return;
        }
        if (data.data.length === 0) {
          displayMessage('operationResult', "Реферальный код не найден");
          return;
        }
        displayMessage('operationResult', `Реферальный код: ${JSON.stringify(data.data[0])}`);
      } catch (error) {
        displayMessage('operationResult', `Ошибка: ${error.message}`, true);
      }
    }

    // Функция для отмены (деактивации) реферального кода (DELETE /api/referrals/{id})
    async function cancelReferral(userId) {
      const token = getAccessToken();
      try {
        // Получаем активную реферальную ссылку по owner_user_id
        const response = await fetch(`/api/referrals/?owner_user_id=${encodeURIComponent(userId)}&active=true`, {
          headers: { "Authorization": token }
        });
        const data = await response.json();
        if (!response.ok) {
          displayMessage('operationResult', `Ошибка при получении кода: ${data.detail ? JSON.stringify(data.detail) : data.message}`, true);
          return;
        }
        if (data.data.length === 0) {
          displayMessage('operationResult', "Активная реферальная ссылка не найдена");
          return;
        }
        const referral = data.data[0];
        const delResponse = await fetch(`/api/referrals/${referral.id}`, {
          method: "DELETE",
          headers: { "Authorization": token }
        });
        const delData = await delResponse.json();
        if (!delResponse.ok) {
          displayMessage('operationResult', `Ошибка при отмене: ${delData.detail ? JSON.stringify(delData.detail) : delData.message}`, true);
          return;
        }
        displayMessage('operationResult', `Реферальный код отменён: ${JSON.stringify(delData.data || delData.message)}`);
      } catch (error) {
        displayMessage('operationResult', `Ошибка: ${error.message}`, true);
      }
    }

    document.getElementById('searchBtn').addEventListener('click', searchUsers);
  </script>
</body>
</html>
