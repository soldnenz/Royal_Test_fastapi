<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    h2 { margin-bottom: 1rem; }
    button { margin-top: 20px; padding: 10px 20px; }
    .error { color: red; margin-bottom: 10px; }
    .success { color: green; margin-bottom: 10px; }
    pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h2>üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
  <div id="message"></div>
  <div id="userInfo"></div>
  <button id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>

  <script>
    const API = "https://royal-test.duckdns.org";
    const messageDiv = document.getElementById("message");
    const userInfoDiv = document.getElementById("userInfo");
    const logoutBtn = document.getElementById("logoutBtn");

    async function fetchProfile() {
      try {
        const response = await fetch(`${API}/users/me`, {
          method: "GET",
          credentials: "include"
        });

        if (!response.ok) {
          if (response.status === 401) {
            messageDiv.innerHTML = `<div class="error">‚õîÔ∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.</div>`;
            setTimeout(() => window.location.href = "/login.html", 1500);
            return;
          }
          throw new Error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è");
        }

        const data = await response.json();
        let html = `<pre>\n–†–æ–ª—å: ${data.role}`;

        if (data.role === "user") {
          html += `
–ò–ò–ù: ${data.iin || "-"}
Email: ${data.email || "-"}
–¢–µ–ª–µ—Ñ–æ–Ω: ${data.phone || "-"}`;
        } else if (data.role === "admin") {
          html += `
–§–ò–û: ${data.full_name || "-"}
–ò–ò–ù: ${data.iin || "-"}`;
        } else {
          html += `\n‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`;
        }

        html += `\n</pre>`;
        userInfoDiv.innerHTML = html;

      } catch (err) {
        console.error(err);
        messageDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${err.message}</div>`;
      }
    }

    logoutBtn.addEventListener("click", async () => {
      try {
        const response = await fetch(`${API}/auth/logout`, {
          method: "POST",
          credentials: "include"
        });

        if (response.ok) {
          messageDiv.innerHTML = `<div class="success">‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏</div>`;
          localStorage.removeItem("access_token");
          setTimeout(() => window.location.href = "/login", 1000);
        } else {
          messageDiv.innerHTML = `<div class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏</div>`;
        }
      } catch (err) {
        messageDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ${err.message}</div>`;
      }
    });

    fetchProfile();
  </script>
</body>
</html>
