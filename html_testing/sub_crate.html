<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–í—ã–¥–∞—á–∞ –ø–æ–¥–ø–∏—Å–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary-color: #FFD700;
      --primary-hover: #e6c200;
      --bg: #f9f9f9;
      --text: #222;
      --border: #ddd;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      padding: 2rem;
      margin: 0;
      color: var(--text);
    }

    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    h1, h2 {
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }

    input, select, textarea, button {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.4rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-sizing: border-box;
      font-size: 1rem;
    }

    button {
      background: var(--primary-color);
      color: #000;
      font-weight: bold;
      border: none;
      margin-top: 1.5rem;
      transition: background 0.2s;
    }

    button:hover {
      background: var(--primary-hover);
    }

    .info-box {
      background: #fff8dc;
      padding: 1rem;
      border-left: 4px solid var(--primary-color);
      margin-top: 1rem;
      font-size: 0.95rem;
      border-radius: 6px;
    }

    .hidden {
      display: none;
    }

    .error {
      color: red;
      font-weight: 600;
      margin-top: 1rem;
    }

    @media (max-width: 600px) {
      .container {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>

    <input type="text" id="search" placeholder="–í–≤–µ–¥–∏—Ç–µ –ò–ò–ù, email, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ ID">
    <button onclick="searchUser()">–ù–∞–π—Ç–∏</button>

    <div id="error" class="error"></div>
    <div id="userInfo" class="info-box hidden"></div>

    <div id="formSection" class="hidden">
      <h2>üì¶ –í—ã–¥–∞—á–∞ –ø–æ–¥–ø–∏—Å–∫–∏</h2>
      <form id="subscriptionForm" onsubmit="submitSubscription(event)">
        <input type="hidden" id="user_id">
        <input type="hidden" id="iin">

        <label>–¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏</label>
        <select id="subscription_type" required>
          <option value="pro">Pro</option>
          <option value="basic">Basic</option>
          <option value="trial">Trial</option>
        </select>

        <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–≤ –¥–Ω—è—Ö)</label>
        <input type="number" id="duration_days" required>

        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
        <input type="date" id="expires_at" required>

        <label>–ú–µ—Ç–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</label>
        <select id="activation_method" required>
          <option value="manual">Manual</option>
          <option value="payment">Payment</option>
          <option value="promocode">Promocode</option>
        </select>

        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="note" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)"></textarea>

        <button type="submit">‚úÖ –í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
      </form>
    </div>
  </div>

  <script>
    const API = "http://127.0.0.1:8000";
    const token = localStorage.getItem("access_token");

    const headers = {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    };

    if (!token) {
      document.getElementById("error").innerText = "‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage (–∫–ª—é—á: access_token)";
    }

    async function searchUser() {
      const query = document.getElementById("search").value.trim();
      const error = document.getElementById("error");
      const userInfo = document.getElementById("userInfo");
      const formSection = document.getElementById("formSection");

      error.innerText = "";
      userInfo.classList.add("hidden");
      formSection.classList.add("hidden");

      if (!query) {
        error.innerText = "–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞";
        return;
      }

      try {
        const res = await fetch(`${API}/users/admin/search_users?query=${encodeURIComponent(query)}`, {
          headers
        });

        if (!res.ok) throw new Error(await res.text());

        const users = await res.json();
        if (!users.length) {
          error.innerText = "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
          return;
        }

        const user = users[0];
        document.getElementById("user_id").value = user.id;
        document.getElementById("iin").value = user.iin || "";

        userInfo.innerHTML = `
          üë§ <b>${user.full_name || "–ë–µ–∑ –∏–º–µ–Ω–∏"}</b><br>
          <b>ID:</b> ${user.id}<br>
          <b>Email:</b> ${user.email || "‚Äî"}<br>
          <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> ${user.phone || "‚Äî"}<br>
          <b>–ò–ò–ù:</b> ${user.iin || "‚Äî"}
        `;

        userInfo.classList.remove("hidden");
        formSection.classList.remove("hidden");

      } catch (e) {
        console.error(e);
        error.innerText = "–û—à–∏–±–∫–∞: " + e.message;
      }
    }

    async function submitSubscription(e) {
      e.preventDefault();
      const payload = {
        user_id: document.getElementById("user_id").value,
        iin: document.getElementById("iin").value,
        subscription_type: document.getElementById("subscription_type").value,
        expires_at: new Date(document.getElementById("expires_at").value).toISOString(),
        activation_method: document.getElementById("activation_method").value,
        note: document.getElementById("note").value,
        duration_days: parseInt(document.getElementById("duration_days").value),
        payment: null
      };

      try {
        const res = await fetch(`${API}/subscriptions/`, {
          method: "POST",
          headers,
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const text = await res.text();
          alert("‚ùå –û—à–∏–±–∫–∞:\n" + text);
          return;
        }

        const data = await res.json();
        alert("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–∞!\nID: " + data._id);

      } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
      }
    }

    // üîÅ –ê–≤—Ç–æ—Å–≤—è–∑—å –º–µ–∂–¥—É –¥–∞—Ç–æ–π –∏ –¥–Ω—è–º–∏
    const durationInput = document.getElementById("duration_days");
    const expiresInput = document.getElementById("expires_at");

    durationInput.addEventListener("input", () => {
      const days = parseInt(durationInput.value);
      if (!isNaN(days)) {
        const now = new Date();
        now.setDate(now.getDate() + days);
        expiresInput.value = now.toISOString().split("T")[0];
      }
    });

    expiresInput.addEventListener("change", () => {
      const selectedDate = new Date(expiresInput.value);
      const now = new Date();
      const diffTime = selectedDate - now;
      const days = Math.round(diffTime / (1000 * 60 * 60 * 24));
      durationInput.value = days > 0 ? days : 0;
    });

    // üïì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.addEventListener("DOMContentLoaded", () => {
      const defaultDays = 30;
      const now = new Date();
      now.setDate(now.getDate() + defaultDays);
      expiresInput.value = now.toISOString().split("T")[0];
      durationInput.value = defaultDays;
    });
  </script>
</body>
</html>
