<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 20px; background: #f4f6f9; }
    .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 1rem; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; }
    input[type="text"], textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 10px 20px; margin: 5px 0; border: none; border-radius: 4px; background: #007bff; color: white; cursor: pointer; }
    button:hover { background: #0056b3; }
    .option-item { display: flex; align-items: center; margin-bottom: 10px; }
    .option-item input[type="text"] { flex: 1; margin-left: 10px; }
    .error { color: red; margin-top: 10px; }
    pre { background: #f0f0f0; padding: 10px; font-size: 13px; }
  </style>
</head>
<body>
<div class="container">
  <h1>–°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞</h1>
  <form id="questionForm">
    <div class="form-group">
      <label for="questionText">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
      <textarea id="questionText" required></textarea>
    </div>

    <div class="form-group">
      <label for="categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä):</label>
      <select id="categories" multiple required>
        <option value="A">A</option>
        <option value="B" selected>B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="CE">CE</option>
        <option value="DE">DE</option>
        <option value="M">M</option>
        <option value="A1">A1</option>
        <option value="B1">B1</option>
        <option value="C1">C1</option>
        <option value="D1">D1</option>
        <option value="BE">BE</option>
      </select>
    </div>

    <div class="form-group">
      <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ (2‚Äì8):</label>
      <div id="optionsContainer"></div>
      <button type="button" onclick="addOption()">+ –í–∞—Ä–∏–∞–Ω—Ç</button>
    </div>

    <div class="form-group">
      <label for="media">–ú–µ–¥–∏–∞—Ñ–∞–π–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
      <input type="file" id="media">
    </div>

    <button type="button" onclick="createQuestion()">–°–æ–∑–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</button>
  </form>

  <div id="result"></div>
  <div id="error" class="error"></div>
</div>

<script>
  let optionCount = 0;
  const minOptions = 2;
  const maxOptions = 8;

  function addOption() {
    if (optionCount >= maxOptions) {
      alert("–ú–∞–∫—Å–∏–º—É–º " + maxOptions + " –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤");
      return;
    }
    const container = document.getElementById("optionsContainer");
    const div = document.createElement("div");
    div.className = "option-item";
    div.id = "option-" + optionCount;
    div.innerHTML = `
      <input type="radio" name="correctOption" value="${optionCount}" ${optionCount === 0 ? "checked" : ""}>
      <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞" required>
      <button type="button" onclick="removeOption(${optionCount})">‚úï</button>
    `;
    container.appendChild(div);
    optionCount++;
  }

  function removeOption(id) {
    const container = document.getElementById("optionsContainer");
    if (container.childElementCount <= minOptions) {
      alert("–ú–∏–Ω–∏–º—É–º " + minOptions + " –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤");
      return;
    }
    const elem = document.getElementById("option-" + id);
    if (elem) {
      container.removeChild(elem);
      optionCount--;
    }
  }

  window.onload = () => {
    addOption();
    addOption();
  };

  async function createQuestion() {
    const errorEl = document.getElementById("error");
    const resultEl = document.getElementById("result");
    errorEl.innerText = "";
    resultEl.innerHTML = "";

    const token = localStorage.getItem("access_token");
    if (!token) {
      errorEl.innerText = "‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage (access_token)";
      return;
    }

    const questionText = document.getElementById("questionText").value.trim();
    if (!questionText) {
      errorEl.innerText = "‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞";
      return;
    }

    const categoryOptions = document.getElementById("categories").selectedOptions;
    const categories = Array.from(categoryOptions).map(o => o.value);
    if (categories.length === 0) {
      errorEl.innerText = "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é";
      return;
    }

    const optionElems = document.getElementById("optionsContainer").children;
    if (optionElems.length < minOptions) {
      errorEl.innerText = `‚ùå –ú–∏–Ω–∏–º—É–º ${minOptions} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤`;
      return;
    }

    const options = [];
    for (let i = 0; i < optionElems.length; i++) {
      const textInput = optionElems[i].querySelector("input[type='text']");
      const text = textInput.value.trim();
      if (!text) {
        errorEl.innerText = "‚ùå –í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏";
        return;
      }
      options.push({ text });
    }

    const correctIndex = Array.from(document.getElementsByName("correctOption"))
      .findIndex(r => r.checked);

    const questionData = {
      question_text: questionText,
      options: options,
      correct_index: correctIndex,
      categories: categories,
      media_filename: document.getElementById("media").files[0]?.name || null
    };

    console.log("üì¶ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º questionData:", questionData);

    const formData = new FormData();
    formData.append("question_data_str", JSON.stringify(questionData));
    const mediaFile = document.getElementById("media").files[0];
    if (mediaFile) {
      formData.append("file", mediaFile);
    }

    try {
      const response = await fetch("http://127.0.0.1:8000/tests/", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
        },
        body: formData
      });

      const data = await response.json();
      console.log("üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);

      if (!response.ok) {
        errorEl.innerText = "‚ùå –û—à–∏–±–∫–∞: " + (data.detail || response.statusText);
      } else {
        resultEl.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        alert("‚úÖ –í–æ–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω");
        document.getElementById("questionForm").reset();
        document.getElementById("optionsContainer").innerHTML = "";
        optionCount = 0;
        addOption();
        addOption();
      }
    } catch (err) {
      errorEl.innerText = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err.message;
    }
  }
</script>
</body>
</html>
