<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прохождение теста - Royal Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white;
        }
        
        .main-content {
            flex-grow: 1;
            padding: 2rem 0;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .question-card {
            margin-top: 1rem;
        }
        
        .question-number {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }
        
        .question-text {
            font-size: 1.4rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }
        
        .question-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .answer-option {
            padding: 12px 20px;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .answer-option:hover {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .answer-option.selected {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .answer-option.correct {
            border-color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.1);
        }
        
        .answer-option.incorrect {
            border-color: var(--accent-color);
            background-color: rgba(231, 76, 60, 0.1);
        }
        
        .answer-label {
            width: 30px;
            height: 30px;
            background-color: #e0e0e0;
            color: #555;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        
        .answer-option:hover .answer-label {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .answer-option.selected .answer-label {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .answer-option.correct .answer-label {
            background-color: var(--success-color);
            color: white;
        }
        
        .answer-option.incorrect .answer-label {
            background-color: var(--accent-color);
            color: white;
        }
        
        .answer-content {
            flex-grow: 1;
        }
        
        .explanation-card {
            background-color: rgba(52, 152, 219, 0.05);
            border-left: 4px solid var(--secondary-color);
            padding: 1rem;
            margin-top: 1.5rem;
            display: none;
        }
        
        .explanation-header {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }
        
        .btn-next {
            background-color: var(--secondary-color);
            border: none;
            padding: 12px 24px;
            font-weight: 600;
            border-radius: 8px;
            color: white;
            margin-top: 1rem;
            transition: all 0.3s;
        }
        
        .btn-next:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-finish {
            background-color: var(--accent-color);
            border: none;
            padding: 12px 24px;
            font-weight: 600;
            border-radius: 8px;
            color: white;
            margin-top: 1rem;
            transition: all 0.3s;
        }
        
        .btn-finish:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .test-progress {
            height: 8px;
            border-radius: 4px;
            background-color: #e0e0e0;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .test-stats {
            background-color: white;
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .test-stat {
            text-align: center;
            padding: 0.5rem 1rem;
            min-width: 100px;
            border-radius: 8px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 0.2rem;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }
        
        .timer-icon {
            font-size: 1.2rem;
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .answer-status {
            display: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin-left: 1rem;
        }
        
        .answer-status.correct {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }
        
        .answer-status.incorrect {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
        }
        
        /* Модальное окно */
        .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .modal-body {
            padding-top: 0;
        }
        
        .modal-footer {
            border-top: none;
        }
        
        .btn-modal-cancel {
            background-color: #e0e0e0;
            color: #555;
            border: none;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .btn-modal-cancel:hover {
            background-color: #d0d0d0;
        }
        
        .btn-modal-confirm {
            background-color: var(--accent-color);
            color: white;
            border: none;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .btn-modal-confirm:hover {
            background-color: #c0392b;
        }
        
        @media (max-width: 768px) {
            .test-stats {
                flex-direction: column;
            }
            
            .test-stat {
                width: 100%;
            }
            
            .question-text {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Заголовок -->
    <header class="header">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="/">Royal Test</a>
                </div>
            </nav>
        </div>
    </header>
    
    <!-- Основной контент -->
    <div class="main-content">
        <div class="container">
            <!-- Прогресс и статистика -->
            <div class="card">
                <div class="card-body">
                    <div class="test-progress">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="test-stats">
                        <div class="test-stat">
                            <div class="stat-label">Вопрос</div>
                            <div class="stat-value"><span id="current-question">1</span>/<span id="total-questions">40</span></div>
                        </div>
                        <div class="test-stat">
                            <div class="stat-label">Правильно</div>
                            <div class="stat-value" id="correct-answers">0</div>
                        </div>
                        <div class="test-stat">
                            <div class="stat-label">Неправильно</div>
                            <div class="stat-value" id="incorrect-answers">0</div>
                        </div>
                        <div class="test-stat">
                            <div class="stat-label">Процент</div>
                            <div class="stat-value" id="percentage">0%</div>
                        </div>
                        <div class="test-stat">
                            <div class="timer">
                                <div class="timer-icon"><i class="fas fa-clock"></i></div>
                                <div class="timer-display" id="timer-display">00:00:00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Карточка вопроса -->
            <div class="card question-card">
                <div class="card-body">
                    <div class="question-number" id="question-number">Вопрос 1 из 40</div>
                    <h2 class="question-text" id="question-text">Загрузка вопроса...</h2>
                    
                    <!-- Изображение вопроса (если есть) -->
                    <div id="question-image-container" style="display: none;">
                        <img src="" id="question-image" class="question-image" alt="Иллюстрация к вопросу" style="display: none;">
                        <video id="question-video" class="question-image" controls style="display: none;">
                            <source src="" type="video/mp4" id="video-source">
                            Ваш браузер не поддерживает воспроизведение видео.
                        </video>
                    </div>
                    
                    <!-- Варианты ответов -->
                    <div id="answer-options" class="mt-4">
                        <!-- Варианты ответов будут добавлены JS -->
                    </div>
                    
                    <!-- Статус ответа -->
                    <div id="answer-status" class="answer-status">Правильно!</div>
                    
                    <!-- Объяснение (отображается после ответа) -->
                    <div id="explanation-card" class="explanation-card">
                        <div class="explanation-header">Объяснение:</div>
                        <div id="explanation-text">Здесь будет объяснение ответа.</div>
                    </div>
                    
                    <!-- Кнопки управления -->
                    <div class="d-flex justify-content-end mt-3">
                        <button id="btn-next" class="btn btn-next" style="display: none;">Следующий вопрос</button>
                        <button id="btn-finish-test" class="btn btn-finish ms-2">Завершить тест</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно подтверждения завершения -->
    <div class="modal fade" id="finish-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Завершить тест?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите завершить тест? Все несохраненные ответы будут потеряны.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-modal-confirm" id="confirm-finish">Завершить</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Скрипты -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Получаем ID лобби из URL
            const urlParams = new URLSearchParams(window.location.search);
            const lobbyId = urlParams.get('id');
            
            if (!lobbyId) {
                alert('Не указан ID теста. Перенаправление на главную страницу.');
                window.location.href = '/';
                return;
            }
            
            // Переменные для работы с тестом
            let currentQuestion = null;
            let currentQuestionIndex = 0;
            let totalQuestions = 40;
            let correctAnswers = 0;
            let incorrectAnswers = 0;
            let questions = {};
            let answeredQuestions = {};
            
            // Инициализация таймера
            const startTime = new Date();
            const timerInterval = setInterval(updateTimer, 1000);
            
            // Обновляем общее количество вопросов
            document.getElementById('total-questions').textContent = totalQuestions;
            
            // Первоначальная загрузка вопроса
            loadQuestion();
            
            // Обработчики событий для кнопок
            document.getElementById('btn-next').addEventListener('click', nextQuestion);
            document.getElementById('btn-finish-test').addEventListener('click', () => {
                // Показываем модальное окно подтверждения
                const finishModal = new bootstrap.Modal(document.getElementById('finish-modal'));
                finishModal.show();
            });
            
            document.getElementById('confirm-finish').addEventListener('click', finishTest);
        });
        
        // Функция загрузки вопроса
        async function loadQuestion() {
            try {
                // Если вопрос уже был загружен, используем его
                if (questions[currentQuestionIndex]) {
                    displayQuestion(questions[currentQuestionIndex]);
                    return;
                }
                
                // Получаем текущий вопрос по индексу
                const response = await fetch(`/api/lobbies/lobbies/${lobbyId}/current-question`);
                if (!response.ok) {
                    throw new Error('Ошибка загрузки вопроса');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.detail || 'Ошибка загрузки вопроса');
                }
                
                currentQuestion = data.data;
                questions[currentQuestionIndex] = currentQuestion;
                
                // Отображаем вопрос
                displayQuestion(currentQuestion);
                
                // Обновляем прогресс
                updateProgress();
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при загрузке вопроса. Пожалуйста, попробуйте снова.');
            }
        }
        
        // Функция отображения вопроса
        function displayQuestion(question) {
            document.getElementById('question-number').textContent = `Вопрос ${currentQuestionIndex + 1} из ${totalQuestions}`;
            document.getElementById('question-text').textContent = question.text;
            
            // Отображаем медиа, если оно есть
            const imageContainer = document.getElementById('question-image-container');
            const questionImage = document.getElementById('question-image');
            const questionVideo = document.getElementById('question-video');
            const videoSource = document.getElementById('video-source');
            
            // Сбрасываем предыдущее изображение/видео
            questionImage.src = '';
            questionImage.style.display = 'none';
            videoSource.src = '';
            questionVideo.style.display = 'none';
            
            // Функция обработки ошибок загрузки медиа
            const handleMediaError = (mediaType) => {
                console.error(`Ошибка загрузки ${mediaType}:`, question.media_file_id);
                if (question.media_file_id) {
                    // Пробуем загрузить как base64, если прямая загрузка не удалась
                    fetch(`/api/files/${question.media_file_id}?as_base64=true`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Ошибка загрузки ${mediaType} в формате base64`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success && data.data.media_base64) {
                                const contentType = data.data.content_type || 'image/jpeg';
                                const isVideo = data.data.is_video || false;
                                
                                if (isVideo) {
                                    // Обработка видео в формате base64
                                    const videoBlob = base64ToBlob(data.data.media_base64, contentType);
                                    const videoUrl = URL.createObjectURL(videoBlob);
                                    videoSource.src = videoUrl;
                                    videoSource.type = contentType;
                                    questionVideo.load();
                                    questionVideo.style.display = 'block';
                                    questionImage.style.display = 'none';
                                    imageContainer.style.display = 'block';
                                } else {
                                    // Обработка изображения в формате base64
                                    questionImage.src = `data:${contentType};base64,${data.data.media_base64}`;
                                    questionImage.style.display = 'block';
                                    questionVideo.style.display = 'none';
                                    imageContainer.style.display = 'block';
                                }
                            } else {
                                imageContainer.style.display = 'none';
                            }
                        })
                        .catch(error => {
                            console.error(`Ошибка при запросе ${mediaType} в формате base64:`, error);
                            imageContainer.style.display = 'none';
                        });
                } else {
                    imageContainer.style.display = 'none';
                }
            };
            
            if (question.media_base64 && question.content_type) {
                // Если есть встроенное base64 изображение с указанием типа
                try {
                    const isVideo = question.content_type.startsWith('video/');
                    
                    if (isVideo) {
                        // Обработка видео в формате base64
                        const videoBlob = base64ToBlob(question.media_base64, question.content_type);
                        const videoUrl = URL.createObjectURL(videoBlob);
                        videoSource.src = videoUrl;
                        videoSource.type = question.content_type;
                        questionVideo.load();
                        questionVideo.style.display = 'block';
                        questionImage.style.display = 'none';
                    } else {
                        // Обработка изображения в формате base64
                        questionImage.src = `data:${question.content_type};base64,${question.media_base64}`;
                        questionImage.style.display = 'block';
                        questionVideo.style.display = 'none';
                    }
                    imageContainer.style.display = 'block';
                } catch (error) {
                    console.error('Ошибка при загрузке base64 медиа:', error);
                    imageContainer.style.display = 'none';
                }
            } else if (question.media_base64) {
                // Если есть встроенное base64 изображение без указания типа (считаем изображением)
                try {
                    questionImage.src = `data:image/jpeg;base64,${question.media_base64}`;
                    questionImage.style.display = 'block';
                    questionVideo.style.display = 'none';
                    imageContainer.style.display = 'block';
                } catch (error) {
                    console.error('Ошибка при загрузке base64 изображения:', error);
                    imageContainer.style.display = 'none';
                }
            } else if (question.media_file_id) {
                // Запрашиваем информацию о типе файла
                fetch(`/api/files/${question.media_file_id}?as_base64=true`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Ошибка получения информации о медиафайле');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success && data.data.media_base64) {
                            const isVideo = data.data.is_video || false;
                            const contentType = data.data.content_type || 'image/jpeg';
                            
                            if (isVideo) {
                                // Показываем видео
                                const videoBlob = base64ToBlob(data.data.media_base64, contentType);
                                const videoUrl = URL.createObjectURL(videoBlob);
                                videoSource.src = videoUrl;
                                videoSource.type = contentType;
                                questionVideo.load();
                                questionVideo.style.display = 'block';
                                questionImage.style.display = 'none';
                                imageContainer.style.display = 'block';
                            } else {
                                // Показываем изображение из base64
                                questionImage.src = `data:${contentType};base64,${data.data.media_base64}`;
                                questionImage.style.display = 'block';
                                questionVideo.style.display = 'none';
                                imageContainer.style.display = 'block';
                            }
                        } else {
                            // Прямое обращение по URL
                            if (data.data && data.data.is_video) {
                                // Это видео, используем видео-элемент
                                videoSource.src = `/api/files/${question.media_file_id}`;
                                videoSource.type = data.data.content_type || 'video/mp4';
                                questionVideo.load();
                                questionVideo.style.display = 'block';
                                questionImage.style.display = 'none';
                                
                                // Обработчик ошибок для видео
                                questionVideo.onerror = () => handleMediaError('видео');
                            } else {
                                // Это изображение, используем img
                                questionImage.src = `/api/files/${question.media_file_id}`;
                                questionImage.style.display = 'block';
                                questionVideo.style.display = 'none';
                                
                                // Обработчик ошибок для изображения
                                questionImage.onerror = () => handleMediaError('изображения');
                            }
                            imageContainer.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка запроса информации о медиафайле:', error);
                        
                        // Пробуем напрямую загрузить как изображение
                        questionImage.src = `/api/files/${question.media_file_id}`;
                        questionImage.style.display = 'block';
                        questionVideo.style.display = 'none';
                        imageContainer.style.display = 'block';
                        
                        // Обработчик ошибок для изображения
                        questionImage.onerror = () => handleMediaError('медиафайла');
                    });
            } else {
                // Нет медиафайла
                imageContainer.style.display = 'none';
            }
            
            // Создаем варианты ответа
            const optionsContainer = document.getElementById('answer-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'answer-option';
                optionElement.dataset.index = index;
                optionElement.innerHTML = `
                    <div class="answer-label">${String.fromCharCode(65 + index)}</div>
                    <div class="answer-content">${option}</div>
                `;
                
                // Если вопрос уже отвечен, применяем соответствующие стили
                if (answeredQuestions[question.id]) {
                    if (answeredQuestions[question.id].selected === index) {
                        if (answeredQuestions[question.id].correct) {
                            optionElement.classList.add('correct');
                        } else {
                            optionElement.classList.add('incorrect');
                        }
                    }
                } else {
                    // Добавляем обработчик клика только для неотвеченных вопросов
                    optionElement.addEventListener('click', () => selectAnswer(index));
                }
                
                optionsContainer.appendChild(optionElement);
            });
            
            // Если вопрос уже был отвечен, показываем объяснение и кнопку "Далее"
            if (answeredQuestions[question.id]) {
                showExplanation(question.explanation);
                document.getElementById('btn-next').style.display = 'block';
                
                // Показываем статус ответа
                const statusElement = document.getElementById('answer-status');
                if (answeredQuestions[question.id].correct) {
                    statusElement.className = 'answer-status correct';
                    statusElement.textContent = 'Правильно!';
                } else {
                    statusElement.className = 'answer-status incorrect';
                    statusElement.textContent = 'Неправильно!';
                }
                statusElement.style.display = 'inline-block';
            } else {
                // Скрываем объяснение и кнопку "Далее" для новых вопросов
                document.getElementById('explanation-card').style.display = 'none';
                document.getElementById('btn-next').style.display = 'none';
                document.getElementById('answer-status').style.display = 'none';
            }
        }
        
        // Функция выбора ответа
        async function selectAnswer(index) {
            // Если вопрос уже отвечен, ничего не делаем
            if (answeredQuestions[currentQuestion.id]) {
                return;
            }
            
            try {
                // Отправляем ответ на сервер
                const response = await fetch(`/api/lobbies/lobbies/${lobbyId}/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_id: currentQuestion.id,
                        answer_index: index
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Ошибка отправки ответа');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.detail || 'Ошибка отправки ответа');
                }
                
                const isCorrect = data.data.is_correct;
                
                // Обновляем счетчик правильных/неправильных ответов
                if (isCorrect) {
                    correctAnswers++;
                    document.getElementById('correct-answers').textContent = correctAnswers;
                } else {
                    incorrectAnswers++;
                    document.getElementById('incorrect-answers').textContent = incorrectAnswers;
                }
                
                // Обновляем процент правильных ответов
                const answered = correctAnswers + incorrectAnswers;
                const percentage = answered > 0 ? Math.round((correctAnswers / answered) * 100) : 0;
                document.getElementById('percentage').textContent = `${percentage}%`;
                
                // Сохраняем информацию о ответе
                answeredQuestions[currentQuestion.id] = {
                    selected: index,
                    correct: isCorrect
                };
                
                // Отмечаем выбранный ответ
                const options = document.querySelectorAll('.answer-option');
                options.forEach(opt => {
                    const optIndex = parseInt(opt.dataset.index);
                    if (optIndex === index) {
                        if (isCorrect) {
                            opt.classList.add('correct');
                        } else {
                            opt.classList.add('incorrect');
                        }
                    }
                    
                    // Удаляем обработчики событий
                    opt.replaceWith(opt.cloneNode(true));
                });
                
                // Показываем статус ответа
                const statusElement = document.getElementById('answer-status');
                if (isCorrect) {
                    statusElement.className = 'answer-status correct';
                    statusElement.textContent = 'Правильно!';
                } else {
                    statusElement.className = 'answer-status incorrect';
                    statusElement.textContent = 'Неправильно!';
                }
                statusElement.style.display = 'inline-block';
                
                // Показываем объяснение
                showExplanation(currentQuestion.explanation);
                
                // Показываем кнопку "Далее"
                document.getElementById('btn-next').style.display = 'block';
                
                // Обновляем прогресс
                updateProgress();
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при отправке ответа. Пожалуйста, попробуйте снова.');
            }
        }
        
        // Функция показа объяснения
        function showExplanation(explanation) {
            const explanationCard = document.getElementById('explanation-card');
            document.getElementById('explanation-text').textContent = explanation;
            explanationCard.style.display = 'block';
        }
        
        // Функция перехода к следующему вопросу
        function nextQuestion() {
            // Проверяем, есть ли следующий вопрос
            if (currentQuestionIndex < totalQuestions - 1) {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = currentQuestionIndex + 1;
                loadQuestion();
            } else {
                // Если это был последний вопрос, завершаем тест
                finishTest();
            }
        }
        
        // Функция обновления прогресса
        function updateProgress() {
            const answered = Object.keys(answeredQuestions).length;
            const progressPercent = (answered / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
        }
        
        // Функция завершения теста
        async function finishTest() {
            try {
                clearInterval(timerInterval);
                
                // Отправляем запрос на завершение теста
                const response = await fetch(`/api/lobbies/lobbies/${lobbyId}/finish`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Ошибка завершения теста');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.detail || 'Ошибка завершения теста');
                }
                
                // Перенаправляем на страницу результатов
                window.location.href = `/results.html?id=${lobbyId}`;
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при завершении теста. Пожалуйста, попробуйте снова.');
            }
        }
        
        // Функция обновления таймера
        function updateTimer() {
            const now = new Date();
            const diff = now - startTime;
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('timer-display').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Функция для преобразования base64 в Blob
        function base64ToBlob(base64, contentType) {
            const byteCharacters = atob(base64);
            const byteArrays = [];
            
            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            
            return new Blob(byteArrays, {type: contentType});
        }
    </script>
</body>
</html> 