<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üß† –í–æ–ø—Ä–æ—Å—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      padding: 2rem;
      margin: 0;
    }
    h1 {
      text-align: center;
      color: #222;
      margin-bottom: 2rem;
    }
    .question-card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      transition: 0.3s;
    }
    .question-card:hover {
      transform: scale(1.01);
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .question-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #333;
    }
    .meta {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.5rem;
    }
    .uid {
      font-size: 0.8rem;
      color: #999;
      margin-top: 6px;
    }
    .details {
      margin-top: 1rem;
      border-top: 1px solid #eee;
      padding-top: 1rem;
      display: none;
    }
    .option {
      margin-left: 1rem;
      padding: 4px 0;
    }
    .option.correct {
      font-weight: bold;
      color: green;
    }
    button.toggle-btn,
    button.edit-btn,
    button.delete-btn {
      background: #ffd700;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
      margin: 0 5px;
    }
    button.toggle-btn:hover,
    button.edit-btn:hover,
    button.delete-btn:hover {
      background: #e6c200;
    }
    img,
    video {
      max-width: 100%;
      margin-top: 1rem;
      border-radius: 8px;
    }
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #f3f3f3;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.2s;
    }
    @media (max-width: 600px) {
      .question-header {
        flex-direction: column;
        align-items: flex-start;
      }
      button.toggle-btn,
      button.edit-btn,
      button.delete-btn {
        width: 100%;
        margin-top: 5px;
      }
    }
  </style>
</head>
<body>
  <h1>üìã –í–æ–ø—Ä–æ—Å—ã</h1>
  <div id="questionsContainer"></div>

  <script>
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function fetchAllQuestions() {
      try {
        const res = await fetch('/api/tests/all', { credentials: "include" });
        const response = await res.json();
        if (response.status === "ok" && Array.isArray(response.data)) {
          renderQuestions(response.data);
        } else {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:", response.message);
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
      }
    }

    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
    function renderQuestions(questions) {
      const container = document.getElementById("questionsContainer");
      container.innerHTML = "";
      questions.forEach(q => {
        const div = document.createElement("div");
        div.className = "question-card";
        div.innerHTML = `
          <div class="question-header">
            <h3>${q.question_text}</h3>
            <div>
              <button class="toggle-btn" onclick="toggleDetails('${q.uid}', this)">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
              <button class="edit-btn" onclick="redirectToEdit('${q.uid}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="delete-btn" onclick="deleteQuestion('${q.uid}')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
          <div class="meta">
            –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: ${q.categories.join(", ")} | –ú–µ–¥–∏–∞: ${q.has_media ? "‚úÖ" : "‚ùå"}
            <div class="uid">UID: ${q.uid}</div>
          </div>
          <div class="details"></div>
        `;
        container.appendChild(div);
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    async function toggleDetails(uid, btn) {
      const questionCard = btn.closest('.question-card');
      const detailsDiv = questionCard.querySelector(".details");

      // –ï—Å–ª–∏ –¥–µ—Ç–∞–ª–∏ —É–∂–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã ‚Äì —Å–∫—Ä—ã–≤–∞–µ–º –∏—Ö
      if (detailsDiv.style.display === "block") {
        detailsDiv.style.display = "none";
        btn.textContent = "–ü–æ–¥—Ä–æ–±–Ω–µ–µ";
        return;
      }

      // –û—á–∏—Å—Ç–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
      detailsDiv.innerHTML = "";
      const progressBar = document.createElement("div");
      progressBar.className = "progress-bar";
      const progressBarInner = document.createElement("div");
      progressBarInner.className = "progress-bar-inner";
      progressBar.appendChild(progressBarInner);
      detailsDiv.appendChild(progressBar);
      detailsDiv.style.display = "block";

      try {
        const res = await fetch(`/api/tests/by_uid/${uid}`, { credentials: "include" });
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–µ—Ç–∞–ª–µ–π");

        const contentLengthHeader = res.headers.get('Content-Length');
        const contentLength = contentLengthHeader ? parseInt(contentLengthHeader, 10) : null;
        let receivedLength = 0;
        const chunks = [];

        if (res.body && res.body.getReader) {
          const reader = res.body.getReader();
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            chunks.push(value);
            receivedLength += value.length;
            if (contentLength) {
              const percent = (receivedLength / contentLength) * 100;
              progressBarInner.style.width = `${percent}%`;
            } else {
              progressBarInner.style.width = '50%';
            }
          }
        } else {
          const textData = await res.text();
          chunks.push(new TextEncoder().encode(textData));
          progressBarInner.style.width = '100%';
        }

        const chunksAll = new Uint8Array(receivedLength);
        let position = 0;
        for (let chunk of chunks) {
          chunksAll.set(chunk, position);
          position += chunk.length;
        }

        const resultText = new TextDecoder("utf-8").decode(chunksAll);
        const parsedResponse = JSON.parse(resultText);
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ (–µ—Å–ª–∏ –æ–Ω –≤–ª–æ–∂–µ–Ω –≤ data)
        const data = parsedResponse.data ? parsedResponse.data : parsedResponse;
        displayQuestionDetails(data, detailsDiv);
        btn.textContent = "–°–∫—Ä—ã—Ç—å";
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ—Ç–∞–ª–µ–π:", error);
        detailsDiv.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π.</p>`;
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ data
    function displayQuestionDetails(data, container) {
      let html = "";
      html += `<p><strong>–í–æ–ø—Ä–æ—Å:</strong> ${data.question_text}</p>`;
      html += `<p><strong>–ü–æ—è—Å–Ω–µ–Ω–∏–µ:</strong> ${data.explanation}</p>`;
      html += `<p><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> ${data.correct_label}</p>`;

      if (data.options && Array.isArray(data.options)) {
        html += `<p><strong>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞:</strong></p><ul>`;
        data.options.forEach(opt => {
          html += `<li><strong>${opt.label}:</strong> ${opt.text}</li>`;
        });
        html += `</ul>`;
      }
      
      if (data.categories && Array.isArray(data.categories)) {
        html += `<p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</strong> ${data.categories.join(", ")}</p>`;
      }
      
      if (data.pdd_section_uids && Array.isArray(data.pdd_section_uids)) {
        html += `<p><strong>PDD Section UIDs:</strong> ${data.pdd_section_uids.join(", ")}</p>`;
      }
      
      html += `<p><strong>–°–æ–∑–¥–∞–Ω:</strong> ${data.created_by_name} (IIN: ${data.created_by_iin})</p>`;
      html += `<p><strong>UID:</strong> ${data.uid}</p>`;
      html += `<p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${data.created_at}</p>`;
      html += `<p><strong>–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</strong> ${data.updated_at ? data.updated_at : "–ù–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è"}</p>`;
      html += `<p><strong>–£–¥–∞–ª—ë–Ω:</strong> ${data.deleted ? "–î–∞" : "–ù–µ—Ç"}</p>`;
      html += `<p><strong>–£–¥–∞–ª—ë–Ω –∫–µ–º:</strong> ${data.deleted_by ? data.deleted_by : "-"}</p>`;
      html += `<p><strong>–î–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è:</strong> ${data.deleted_at ? data.deleted_at : "-"}</p>`;
      html += `<p><strong>Media File ID:</strong> ${data.media_file_id ? data.media_file_id : "-"}</p>`;
      html += `<p><strong>Media Filename:</strong> ${data.media_filename ? data.media_filename : "-"}</p>`;
      html += `<p><strong>ID:</strong> ${data.id}</p>`;

      // –ï—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞, –≤—ã–≤–æ–¥–∏–º –∏—Ö
      if (data.media_file_base64 && data.media_filename) {
        if (data.media_filename.endsWith(".mp4")) {
          html += `<video controls src="data:video/mp4;base64,${data.media_file_base64}"></video>`;
        } else {
          html += `<img src="data:image/*;base64,${data.media_file_base64}" alt="–ú–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç">`;
        }
      }
      
      container.innerHTML = html;
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
    function redirectToEdit(uid) {
      window.location.href = `/edit_question.html?uid=${uid}`;
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
    async function deleteQuestion(uid) {
      try {
        const res = await fetch(`/api/tests/${uid}`, {
          method: 'DELETE',
          credentials: "include"
        });
        if (res.ok) {
          alert('–í–æ–ø—Ä–æ—Å —É–¥–∞–ª—ë–Ω');
          fetchAllQuestions();
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞');
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞:", error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞');
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
    fetchAllQuestions();
  </script>
</body>
</html>
